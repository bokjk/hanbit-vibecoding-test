name: Security Scan

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— ì‹¤í–‰
    - cron: "0 0 * * 1"
  workflow_dispatch:
    inputs:
      scan_type:
        description: "ìŠ¤ìº” ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”"
        required: true
        default: "full"
        type: choice
        options:
          - "full"
          - "dependencies"
          - "code"

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.13.1"

jobs:
  security-audit:
    name: ë³´ì•ˆ ê°ì‚¬
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
        if: github.event.inputs.scan_type == 'dependencies' || github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
        run: |
          echo "ğŸ” ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."

          # npm audit ì‹¤í–‰
          pnpm audit --audit-level low --json > npm-audit-report.json || true

          # ê²°ê³¼ ë¶„ì„
          CRITICAL=$(cat npm-audit-report.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length' 2>/dev/null || echo "0")
          HIGH=$(cat npm-audit-report.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length' 2>/dev/null || echo "0")
          MODERATE=$(cat npm-audit-report.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "moderate")) | length' 2>/dev/null || echo "0")

          echo "Critical: $CRITICAL"
          echo "High: $HIGH" 
          echo "Moderate: $MODERATE"

          # GitHub Step Summaryì— ê²°ê³¼ ì¶”ê°€
          echo "## ğŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY

      - name: OWASP Dependency Check
        if: github.event.inputs.scan_type == 'dependencies' || github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "hanbit-vibecoding"
          path: "."
          format: "ALL"
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
        continue-on-error: true

      - name: CodeQL ë¶„ì„
        if: github.event.inputs.scan_type == 'code' || github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          queries: security-extended,security-and-quality

      - name: CodeQL ìë™ ë¹Œë“œ
        if: github.event.inputs.scan_type == 'code' || github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        if: github.event.inputs.scan_type == 'code' || github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
        uses: github/codeql-action/analyze@v3

      - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results-${{ github.run_id }}
          path: |
            npm-audit-report.json
            reports/
          retention-days: 90

      - name: Slack ë³´ì•ˆ ì•Œë¦¼
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: "#security"
          text: |
            ğŸš¨ **ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬!**
            - ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}
            - ë¸Œëœì¹˜: ${{ github.ref_name }}
            - ì‹¤í–‰ ì‹œê°„: $(date)
            ìƒì„¸ ê²°ê³¼ëŠ” GitHub Actionsì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
