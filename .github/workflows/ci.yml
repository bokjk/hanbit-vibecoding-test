name: ê°•í™”ëœ í’ˆì§ˆ ê²Œì´íŠ¸ CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°"
        required: false
        default: "false"
        type: boolean
      environment:
        description: "í’ˆì§ˆ ê²Œì´íŠ¸ í™˜ê²½"
        required: false
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.13.1"
  # í’ˆì§ˆ ê²Œì´íŠ¸ ìž„ê³„ê°’
  COVERAGE_THRESHOLD: 85
  PERFORMANCE_THRESHOLD: 90
  SECURITY_THRESHOLD: 85
  ACCESSIBILITY_THRESHOLD: 95

jobs:
  # 1. ê¸°ë³¸ ê²€ì¦ (ë¦°íŠ¸, íƒ€ìž… ì²´í¬, ìœ ë‹› í…ŒìŠ¤íŠ¸)
  validate:
    name: ê¸°ë³¸ ê²€ì¦
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: íƒ€ìž… ì²´í¬ - í´ë¼ì´ì–¸íŠ¸
        run: pnpm --filter @vive/client type-check

      - name: íƒ€ìž… ì²´í¬ - ì„œë²„
        run: pnpm --filter @vive/server type-check

      - name: ë¦°íŠ¸ ê²€ì‚¬ - í´ë¼ì´ì–¸íŠ¸
        run: pnpm --filter @vive/client lint

      - name: ë¦°íŠ¸ ê²€ì‚¬ - ì„œë²„
        run: pnpm --filter @vive/server lint

      - name: ìœ ë‹› í…ŒìŠ¤íŠ¸ - í´ë¼ì´ì–¸íŠ¸
        run: pnpm --filter @vive/client test --coverage

      - name: ìœ ë‹› í…ŒìŠ¤íŠ¸ - ì„œë²„
        run: pnpm --filter @vive/server test --coverage

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            apps/client/coverage/
            apps/server/coverage/
          retention-days: 30

  # 2. Contract Testing - API ìŠ¤í‚¤ë§ˆ ê²€ì¦
  contract-tests:
    name: Contract Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: OpenAPI ìŠ¤í‚¤ë§ˆ ê²€ì¦
        run: |
          cd apps/server
          # OpenAPI ìŠ¤í‚¤ë§ˆ ë¬¸ë²• ê²€ì¦
          npx swagger-parser validate openapi/api-schema.yaml

      - name: Contract í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          cd apps/server
          pnpm test:contract --reporter=verbose --reporter=json --outputFile=contract-test-results.json
        env:
          NODE_ENV: test
          IS_CONTRACT_TEST: true

      - name: Contract í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
        run: |
          cd apps/server
          if [ -f contract-test-results.json ]; then
            echo "âœ… Contract í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„:"
            node -e "
              const results = require('./contract-test-results.json');
              const totalTests = results.numTotalTests || 0;
              const passedTests = results.numPassedTests || 0;
              const failedTests = results.numFailedTests || 0;
              
              console.log(\`ì´ í…ŒìŠ¤íŠ¸: \${totalTests}\`);
              console.log(\`ì„±ê³µ: \${passedTests}\`);
              console.log(\`ì‹¤íŒ¨: \${failedTests}\`);
              
              if (failedTests > 0) {
                console.log('\\nâŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:');
                results.testResults?.forEach(suite => {
                  suite.assertionResults?.forEach(test => {
                    if (test.status === 'failed') {
                      console.log(\`  - \${test.title}\`);
                      console.log(\`    \${test.failureMessages?.[0] || 'No error details'}\`);
                    }
                  });
                });
                process.exit(1);
              } else {
                console.log('\\nâœ… ëª¨ë“  Contract í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!');
              }
            "
          else
            echo "âš ï¸ Contract í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Contract í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: contract-test-results
          path: |
            apps/server/contract-test-results.json
            apps/server/test-results/
          retention-days: 30

      - name: Contract í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ ìƒì„±
        if: always()
        run: |
          cd apps/server
          echo "# ðŸ“‹ Contract Testing ë³´ê³ ì„œ" > contract-report.md
          echo "" >> contract-report.md
          echo "## ðŸ” ê²€ì¦ í•­ëª©" >> contract-report.md
          echo "- âœ… OpenAPI ìŠ¤í‚¤ë§ˆ ë¬¸ë²• ê²€ì¦" >> contract-report.md
          echo "- âœ… ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ê²€ì¦" >> contract-report.md
          echo "- âœ… HTTP ìƒíƒœ ì½”ë“œ ì¼ê´€ì„±" >> contract-report.md
          echo "- âœ… ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ê²€ì¦" >> contract-report.md
          echo "- âœ… ë³´ì•ˆ í—¤ë” ê²€ì¦" >> contract-report.md
          echo "- âœ… CORS ì •ì±… ê²€ì¦" >> contract-report.md
          echo "" >> contract-report.md

          if [ -f contract-test-results.json ]; then
            node -e "
              const results = require('./contract-test-results.json');
              const fs = require('fs');
              
              let report = fs.readFileSync('contract-report.md', 'utf8');
              report += '## ðŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼\\n\\n';
              report += \`- ì´ í…ŒìŠ¤íŠ¸: \${results.numTotalTests || 0}\\n\`;
              report += \`- âœ… ì„±ê³µ: \${results.numPassedTests || 0}\\n\`;
              report += \`- âŒ ì‹¤íŒ¨: \${results.numFailedTests || 0}\\n\`;
              report += \`- â±ï¸ ì‹¤í–‰ ì‹œê°„: \${results.testResults?.[0]?.perfStats?.runtime || 0}ms\\n\\n\`;
              
              if (results.numFailedTests > 0) {
                report += '## âŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸\\n\\n';
                results.testResults?.forEach(suite => {
                  suite.assertionResults?.forEach(test => {
                    if (test.status === 'failed') {
                      report += \`### \${test.title}\\n\`;
                      report += \`\\\`\\\`\\\`\\n\${test.failureMessages?.[0] || 'No error details'}\\\`\\\`\\\`\\n\\n\`;
                    }
                  });
                });
              } else {
                report += '## âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì„±ê³µ\\n\\n';
                report += 'í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ì˜ API ê³„ì•½ì´ ì™„ì „ížˆ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.\\n';
              }
              
              fs.writeFileSync('contract-report.md', report);
            "
          fi

      - name: Contract ë³´ê³ ì„œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: contract-report
          path: apps/server/contract-report.md
          retention-days: 30

  # 3. í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [validate, contract-tests]

    services:
      # DynamoDB Local (í…ŒìŠ¤íŠ¸ìš©)
      dynamodb:
        image: amazon/dynamodb-local:latest
        ports:
          - 8000:8000
        options: >-
          --health-cmd="curl -f http://localhost:8000/"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: DynamoDB í…Œì´ë¸” ìƒì„±
        run: |
          # DynamoDB Localì— í…ŒìŠ¤íŠ¸ìš© í…Œì´ë¸” ìƒì„±
          cd apps/server
          node -e "
            const AWS = require('@aws-sdk/client-dynamodb');
            const client = new AWS.DynamoDBClient({
              endpoint: 'http://localhost:8000',
              region: 'us-east-1',
              credentials: {
                accessKeyId: 'dummy',
                secretAccessKey: 'dummy'
              }
            });
            
            async function createTable() {
              try {
                await client.send(new AWS.CreateTableCommand({
                  TableName: 'hanbit-todos-test',
                  KeySchema: [
                    { AttributeName: 'userId', KeyType: 'HASH' },
                    { AttributeName: 'id', KeyType: 'RANGE' }
                  ],
                  AttributeDefinitions: [
                    { AttributeName: 'userId', AttributeType: 'S' },
                    { AttributeName: 'id', AttributeType: 'S' }
                  ],
                  BillingMode: 'PAY_PER_REQUEST'
                }));
                console.log('âœ… DynamoDB í…ŒìŠ¤íŠ¸ í…Œì´ë¸” ìƒì„± ì™„ë£Œ');
              } catch (error) {
                console.error('âŒ DynamoDB í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨:', error.message);
                process.exit(1);
              }
            }
            
            createTable();
          "

      - name: í†µí•© í…ŒìŠ¤íŠ¸ - ì„œë²„
        run: |
          cd apps/server
          pnpm test --testPathPattern=integration --coverage
        env:
          NODE_ENV: test
          DYNAMODB_ENDPOINT: http://localhost:8000
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: dummy
          AWS_SECRET_ACCESS_KEY: dummy

      - name: í†µí•© í…ŒìŠ¤íŠ¸ - í´ë¼ì´ì–¸íŠ¸
        run: |
          cd apps/client
          # í´ë¼ì´ì–¸íŠ¸ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          pnpm test --testPathPattern=integration --coverage

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            apps/client/coverage/
            apps/server/coverage/
          retention-days: 30

  # 4. E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [validate, contract-tests]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: |
          cd apps/client
          npx playwright install --with-deps

      - name: í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ
        run: |
          cd apps/client
          pnpm build

      - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          cd apps/client
          pnpm test:e2e --reporter=html --reporter=json
        env:
          CI: true

      - name: E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            apps/client/playwright-report/
            apps/client/test-results/
          retention-days: 30

  # 5. ë³´ì•ˆ ê²€ì¦
  security-scan:
    name: ë³´ì•ˆ ê²€ì¦
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: contract-tests

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
        run: |
          echo "ðŸ” íŒ¨í‚¤ì§€ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬"
          pnpm audit --audit-level high || true

          echo "ðŸ” ë¼ì´ì„¼ìŠ¤ ê²€ì‚¬"
          npx license-checker --onlyAllow 'MIT;BSD-2-Clause;BSD-3-Clause;Apache-2.0;ISC' || true

      - name: OpenAPI ë³´ì•ˆ ì •ì±… ê²€ì¦
        run: |
          cd apps/server
          echo "ðŸ” OpenAPI ë³´ì•ˆ ì •ì±… ê²€ì¦"

          # ë³´ì•ˆ í—¤ë” ê²€ì¦
          node -e "
            const yaml = require('yaml');
            const fs = require('fs');
            
            const schema = yaml.parse(fs.readFileSync('openapi/api-schema.yaml', 'utf8'));
            
            console.log('âœ… ë³´ì•ˆ ìŠ¤í‚¤ë§ˆ ê²€ì¦:');
            console.log('  - Bearer ì¸ì¦:', schema.components.securitySchemes.BearerAuth ? 'âœ…' : 'âŒ');
            console.log('  - CORS ì‘ë‹µ ì •ì˜:', schema.components.responses.Unauthorized ? 'âœ…' : 'âŒ');
            console.log('  - Rate Limiting í—¤ë”:', 
              JSON.stringify(schema).includes('X-Rate-Limit') ? 'âœ…' : 'âŒ');
            console.log('  - ì—ëŸ¬ ì‘ë‹µ ìŠ¤í‚¤ë§ˆ:', schema.components.schemas.ErrorResponse ? 'âœ…' : 'âŒ');
            
            // ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ê²€ì‚¬
            const schemaStr = JSON.stringify(schema);
            const sensitivePatterns = ['password', 'secret', 'key', 'token'];
            const exposedSensitive = sensitivePatterns.filter(pattern => 
              schemaStr.toLowerCase().includes(pattern) && 
              !schemaStr.includes('description') // ì„¤ëª…ì—ì„œëŠ” í—ˆìš©
            );
            
            if (exposedSensitive.length > 0) {
              console.warn('âš ï¸  ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ê°€ëŠ¥ì„±:', exposedSensitive);
            } else {
              console.log('  - ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ê²€ì‚¬: âœ…');
            }
          "

  # 6. ë¹Œë“œ ë° ë°°í¬ ì¤€ë¹„
  build:
    name: ë¹Œë“œ ë° ë°°í¬ ì¤€ë¹„
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [integration-tests, e2e-tests, security-scan]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ - í´ë¼ì´ì–¸íŠ¸
        run: |
          cd apps/client
          pnpm build
        env:
          NODE_ENV: production

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ - ì„œë²„
        run: |
          cd apps/server
          pnpm build:lambda
        env:
          NODE_ENV: production

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/client/dist/
            apps/server/dist/
          retention-days: 30

      - name: Contract Testing ê²°ê³¼ ìš”ì•½
        run: |
          echo "# ðŸ“‹ CI/CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… ì„±ê³µí•œ ê²€ì¦ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ê¸°ë³¸ ê²€ì¦ (ë¦°íŠ¸, íƒ€ìž… ì²´í¬, ìœ ë‹› í…ŒìŠ¤íŠ¸)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Contract Testing (API ìŠ¤í‚¤ë§ˆ ê²€ì¦)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— í†µí•© í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ­ E2E í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ ë³´ì•ˆ ê²€ì¦" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ì˜ API ê³„ì•½ì´ ê²€ì¦ë˜ì—ˆìœ¼ë©°," >> $GITHUB_STEP_SUMMARY
          echo "ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ í†µê³¼í•˜ì—¬ ë°°í¬ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  # 7. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•© ë¦¬í¬íŠ¸
  test-summary:
    name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    runs-on: ubuntu-latest
    needs:
      [validate, contract-tests, integration-tests, e2e-tests, security-scan]
    if: always()

    steps:
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: "*-test-results"
          merge-multiple: true

      - name: Contract ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: contract-report

      - name: ì¢…í•© í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ ìƒì„±
        run: |
          echo "# ðŸ“Š TODO ì•± í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•© ë³´ê³ ì„œ" > test-summary.md
          echo "" >> test-summary.md
          echo "## ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼" >> test-summary.md
          echo "" >> test-summary.md

          # Job ìƒíƒœ í™•ì¸
          echo "| í…ŒìŠ¤íŠ¸ ë‹¨ê³„ | ìƒíƒœ | ì„¤ëª… |" >> test-summary.md
          echo "|------------|------|------|" >> test-summary.md
          echo "| ê¸°ë³¸ ê²€ì¦ | ${{ needs.validate.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} | ë¦°íŠ¸, íƒ€ìž… ì²´í¬, ìœ ë‹› í…ŒìŠ¤íŠ¸ |" >> test-summary.md
          echo "| Contract Testing | ${{ needs.contract-tests.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} | API ìŠ¤í‚¤ë§ˆ ê²€ì¦, ê³„ì•½ í…ŒìŠ¤íŠ¸ |" >> test-summary.md
          echo "| í†µí•© í…ŒìŠ¤íŠ¸ | ${{ needs.integration-tests.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} | ì»´í¬ë„ŒíŠ¸ ê°„ í†µí•© ê²€ì¦ |" >> test-summary.md
          echo "| E2E í…ŒìŠ¤íŠ¸ | ${{ needs.e2e-tests.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} | ì‚¬ìš©ìž ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ |" >> test-summary.md
          echo "| ë³´ì•ˆ ê²€ì¦ | ${{ needs.security-scan.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} | ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ |" >> test-summary.md
          echo "" >> test-summary.md

          # Contract Testing í•˜ì´ë¼ì´íŠ¸
          echo "## ðŸ” Contract Testing í•˜ì´ë¼ì´íŠ¸" >> test-summary.md
          echo "" >> test-summary.md
          if [ -f contract-report.md ]; then
            cat contract-report.md >> test-summary.md
          else
            echo "Contract í…ŒìŠ¤íŠ¸ëŠ” í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ì˜ API ê³„ì•½ì„ ë³´ìž¥í•©ë‹ˆë‹¤:" >> test-summary.md
            echo "- âœ… OpenAPI ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜" >> test-summary.md
            echo "- âœ… ìš”ì²­/ì‘ë‹µ í˜•ì‹ ì¼ê´€ì„±" >> test-summary.md
            echo "- âœ… ì—ëŸ¬ ì²˜ë¦¬ í‘œì¤€í™”" >> test-summary.md
            echo "- âœ… ë³´ì•ˆ í—¤ë” ê²€ì¦" >> test-summary.md
          fi
          echo "" >> test-summary.md

          # ì „ì²´ ê²°ê³¼
          ALL_SUCCESS="${{ needs.validate.result == 'success' && needs.contract-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success' && needs.security-scan.result == 'success' }}"

          if [ "$ALL_SUCCESS" = "true" ]; then
            echo "## âœ… ì „ì²´ í…ŒìŠ¤íŠ¸ ì„±ê³µ!" >> test-summary.md
            echo "" >> test-summary.md
            echo "ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ë°°í¬ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> test-summary.md
          else
            echo "## âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨" >> test-summary.md
            echo "" >> test-summary.md
            echo "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤." >> test-summary.md
          fi

      - name: í…ŒìŠ¤íŠ¸ ìš”ì•½ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-report
          path: test-summary.md
          retention-days: 90

      - name: GitHub Summary ì—…ë°ì´íŠ¸
        run: |
          if [ -f test-summary.md ]; then
            cat test-summary.md >> $GITHUB_STEP_SUMMARY
          fi
