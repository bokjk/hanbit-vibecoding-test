name: í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸ ì›Œí¬í”Œë¡œìš°

on:
  push:
    branches:
      - main
    paths:
      - "apps/server/**"
      - "packages/**"
  workflow_dispatch:
    inputs:
      deployment_type:
        description: "ë°°í¬ íƒ€ì…"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - hotfix
          - rollback
      rollback_target:
        description: "ë¡¤ë°± ëŒ€ìƒ (ë¡¤ë°± ì‹œë§Œ í•„ìš”)"
        required: false
        type: string
      force_deploy:
        description: "ê°•ì œ ë°°í¬ (ìŠ¹ì¸ ì—†ì´)"
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-northeast-2
  ENVIRONMENT: prod

jobs:
  # 1ë‹¨ê³„: ì‚¬ì „ ê²€ì¦
  pre-deployment-checks:
    name: ë°°í¬ ì‚¬ì „ ê²€ì¦
    runs-on: ubuntu-latest
    outputs:
      deployment-id: ${{ steps.generate-id.outputs.deployment-id }}
      approval-required: ${{ steps.check-approval.outputs.approval-required }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë°°í¬ ID ìƒì„±
        id: generate-id
        run: |
          DEPLOYMENT_ID="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:8}"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "ğŸ†” ë°°í¬ ID: $DEPLOYMENT_ID"

      - name: ë³€ê²½ì‚¬í•­ ë¶„ì„
        id: analyze-changes
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ìƒì„±
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "ë³€ê²½ëœ íŒŒì¼:"
          echo "$CHANGED_FILES"

          # ì¤‘ìš” íŒŒì¼ ë³€ê²½ ì—¬ë¶€ í™•ì¸
          CRITICAL_FILES=$(echo "$CHANGED_FILES" | grep -E "(infrastructure/|lambda/|package\.json)" || true)

          if [ -n "$CRITICAL_FILES" ]; then
            echo "critical-changes=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì¤‘ìš” íŒŒì¼ ë³€ê²½ ê°ì§€"
          else
            echo "critical-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… ì¼ë°˜ íŒŒì¼ ë³€ê²½"
          fi

          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ìŠ¹ì¸ í•„ìš” ì—¬ë¶€ í™•ì¸
        id: check-approval
        run: |
          FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"
          DEPLOYMENT_TYPE="${{ github.event.inputs.deployment_type }}"
          CRITICAL_CHANGES="${{ steps.analyze-changes.outputs.critical-changes }}"

          if [ "$FORCE_DEPLOY" = "true" ]; then
            echo "approval-required=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ ê°•ì œ ë°°í¬ ëª¨ë“œ"
          elif [ "$DEPLOYMENT_TYPE" = "hotfix" ]; then
            echo "approval-required=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¥ í•«í”½ìŠ¤ ë°°í¬ - ìŠ¹ì¸ ìƒëµ"
          elif [ "$CRITICAL_CHANGES" = "true" ] || [ "$DEPLOYMENT_TYPE" = "deploy" ]; then
            echo "approval-required=true" >> $GITHUB_OUTPUT
            echo "âœ‹ ìŠ¹ì¸ í•„ìš”"
          else
            echo "approval-required=false" >> $GITHUB_OUTPUT
            echo "âœ… ìë™ ë°°í¬ ê°€ëŠ¥"
          fi

      - name: ë³´ì•ˆ ìŠ¤ìº”
        run: |
          echo "ğŸ” ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰"
          # ì‹¤ì œ ë³´ì•ˆ ìŠ¤ìº” ë„êµ¬ ì‹¤í–‰ (ì˜ˆ: npm audit, snyk ë“±)
          cd apps/server
          npm audit --audit-level moderate

          echo "âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"

      - name: ë°°í¬ ì‹œì‘ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: custom
          custom_payload: |
            {
              text: "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘",
              attachments: [{
                color: "warning",
                fields: [
                  { title: "ë°°í¬ ID", value: "${{ steps.generate-id.outputs.deployment-id }}", short: true },
                  { title: "ë°°í¬ íƒ€ì…", value: "${{ github.event.inputs.deployment_type || 'deploy' }}", short: true },
                  { title: "ì»¤ë°‹", value: "${{ github.sha }}", short: true },
                  { title: "ìŠ¹ì¸ í•„ìš”", value: "${{ steps.check-approval.outputs.approval-required }}", short: true },
                  { title: "ë³€ê²½ì‚¬í•­", value: "${{ steps.analyze-changes.outputs.changed-files }}", short: false }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # 2ë‹¨ê³„: ìŠ¹ì¸ ìš”ì²­ (í•„ìš”ì‹œ)
  approval-gate:
    name: ë°°í¬ ìŠ¹ì¸ ìš”ì²­
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.approval-required == 'true'
    environment:
      name: production-approval
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: ìŠ¹ì¸ ëŒ€ê¸°
        run: |
          echo "â³ ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘..."
          echo "ë°°í¬ ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
          echo "ìŠ¹ì¸ìê°€ GitHub Environmentì—ì„œ ìŠ¹ì¸í•´ì•¼ í•©ë‹ˆë‹¤."

      - name: ìŠ¹ì¸ ì™„ë£Œ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸ ì™„ë£Œ - ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # 3ë‹¨ê³„: ì‹¤ì œ ë°°í¬
  deploy-to-production:
    name: í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, approval-gate]
    if: always() && (needs.approval-gate.result == 'success' || needs.pre-deployment-checks.outputs.approval-required == 'false')
    environment: production
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd apps/server
          npm ci

      - name: ë°°í¬ ê¸°ë¡ ì‹œì‘
        id: record-start
        run: |
          # ë°°í¬ ì‹œì‘ ì •ë³´ë¥¼ DynamoDBì— ê¸°ë¡
          aws dynamodb put-item \
            --region ${{ env.AWS_REGION }} \
            --table-name deployment-history-prod \
            --item '{
              "deploymentId": {"S": "${{ needs.pre-deployment-checks.outputs.deployment-id }}"},
              "timestamp": {"S": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"},
              "environment": {"S": "prod"},
              "status": {"S": "in_progress"},
              "deploymentType": {"S": "${{ github.event.inputs.deployment_type || 'deploy' }}"},
              "commitSha": {"S": "${{ github.sha }}"},
              "deployedBy": {"S": "${{ github.actor }}"},
              "details": {"S": "{\"trigger\": \"${{ github.event_name }}\", \"ref\": \"${{ github.ref }}\"}"},
              "ttl": {"N": "'$(($(date +%s) + 7776000))'"}
            }' || echo "ë°°í¬ ê¸°ë¡ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

      - name: CDK ë°°í¬
        id: cdk-deploy
        run: |
          cd apps/server/infrastructure

          # CDK ì„¤ì¹˜
          npm install -g aws-cdk
          npm ci

          echo "ğŸš€ CDK ë°°í¬ ì‹œì‘"
          DEPLOY_START_TIME=$(date +%s)

          # ë°°í¬ ì‹¤í–‰
          cdk deploy HanbitTodoStack-prod \
            --require-approval never \
            --outputs-file outputs.json \
            --context environment=prod

          DEPLOY_END_TIME=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))

          echo "deploy-duration=$DEPLOY_DURATION" >> $GITHUB_OUTPUT
          echo "âœ… CDK ë°°í¬ ì™„ë£Œ (ì†Œìš”ì‹œê°„: ${DEPLOY_DURATION}ì´ˆ)"

      - name: ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬
        id: health-check
        run: |
          echo "ğŸ¥ ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬ ì‹œì‘"

          # CDK ì¶œë ¥ì—ì„œ API ì—”ë“œí¬ì¸íŠ¸ ì¶”ì¶œ
          if [ -f apps/server/infrastructure/outputs.json ]; then
            API_ENDPOINT=$(cat apps/server/infrastructure/outputs.json | jq -r '.["HanbitTodoStack-prod"].ApiEndpointProd // empty')
          fi

          if [ -z "$API_ENDPOINT" ]; then
            # ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ CloudFormation ìŠ¤íƒì—ì„œ ì¶”ì¶œ
            API_ENDPOINT=$(aws cloudformation describe-stacks \
              --region ${{ env.AWS_REGION }} \
              --stack-name HanbitTodoStack-prod \
              --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpointProd`].OutputValue' \
              --output text)
          fi

          if [ -z "$API_ENDPOINT" ]; then
            echo "âŒ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "API ì—”ë“œí¬ì¸íŠ¸: $API_ENDPOINT"

          # í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
          for i in {1..30}; do
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/30"
            
            if curl -f --max-time 10 "${API_ENDPOINT}/health" > /dev/null 2>&1; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
              echo "health-check-passed=true" >> $GITHUB_OUTPUT
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ìë™ ë¡¤ë°± íŠ¸ë¦¬ê±°"
              echo "health-check-passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            sleep 10
          done

      - name: ë°°í¬ ì„±ê³µ ê¸°ë¡
        if: success()
        run: |
          # ë°°í¬ ì„±ê³µ ì •ë³´ ì—…ë°ì´íŠ¸
          aws dynamodb update-item \
            --region ${{ env.AWS_REGION }} \
            --table-name deployment-history-prod \
            --key '{
              "deploymentId": {"S": "${{ needs.pre-deployment-checks.outputs.deployment-id }}"},
              "timestamp": {"S": "'$(aws dynamodb get-item --table-name deployment-history-prod --key "{\"deploymentId\": {\"S\": \"${{ needs.pre-deployment-checks.outputs.deployment-id }}\"}}" --query 'Item.timestamp.S' --output text)'"'}
            }' \
            --update-expression "SET #status = :status, duration = :duration, details = :details" \
            --expression-attribute-names '{"#status": "status"}' \
            --expression-attribute-values '{
              ":status": {"S": "success"},
              ":duration": {"N": "${{ steps.cdk-deploy.outputs.deploy-duration }}"},
              ":details": {"S": "{\"healthCheckPassed\": true, \"deployDuration\": ${{ steps.cdk-deploy.outputs.deploy-duration }}}"}
            }' || echo "ë°°í¬ ì„±ê³µ ê¸°ë¡ ì‹¤íŒ¨"

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ğŸ‰ í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!

            ë°°í¬ ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}
            ì†Œìš”ì‹œê°„: ${{ steps.cdk-deploy.outputs.deploy-duration }}ì´ˆ
            ì»¤ë°‹: ${{ github.sha }}
            ë°°í¬ì: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # 4ë‹¨ê³„: ë¡¤ë°± ì²˜ë¦¬ (ì‹¤íŒ¨ì‹œ)
  rollback-on-failure:
    name: ìë™ ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-to-production]
    if: failure()
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ìë™ ë¡¤ë°± ì‹¤í–‰
        run: |
          echo "ğŸ”„ ìë™ ë¡¤ë°± ì‹œì‘"

          # Lambda í•¨ìˆ˜ë¥¼ í†µí•œ ë¡¤ë°± íŠ¸ë¦¬ê±°
          aws lambda invoke \
            --region ${{ env.AWS_REGION }} \
            --function-name "HanbitTodoStack-prod-DeploymentMonitoring-RollbackFunction" \
            --payload '{"deploymentId": "${{ needs.pre-deployment-checks.outputs.deployment-id }}", "reason": "deployment_failure"}' \
            rollback-response.json

          echo "ë¡¤ë°± ì‘ë‹µ:"
          cat rollback-response.json

      - name: ë°°í¬ ì‹¤íŒ¨ ê¸°ë¡
        run: |
          # ë°°í¬ ì‹¤íŒ¨ ì •ë³´ ê¸°ë¡
          aws dynamodb update-item \
            --region ${{ env.AWS_REGION }} \
            --table-name deployment-history-prod \
            --key '{
              "deploymentId": {"S": "${{ needs.pre-deployment-checks.outputs.deployment-id }}"},
              "timestamp": {"S": "'$(aws dynamodb get-item --table-name deployment-history-prod --key "{\"deploymentId\": {\"S\": \"${{ needs.pre-deployment-checks.outputs.deployment-id }}\"}}" --query 'Item.timestamp.S' --output text)'"'}
            }' \
            --update-expression "SET #status = :status, errorMessage = :error, details = :details" \
            --expression-attribute-names '{"#status": "status"}' \
            --expression-attribute-values '{
              ":status": {"S": "failure"},
              ":error": {"S": "Deployment failed, automatic rollback triggered"},
              ":details": {"S": "{\"autoRollback\": true, \"failureReason\": \"deployment_failure\"}"}
            }' || echo "ë°°í¬ ì‹¤íŒ¨ ê¸°ë¡ ì‹¤íŒ¨"

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ğŸš¨ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨!

            ë°°í¬ ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}
            ì»¤ë°‹: ${{ github.sha }}
            ë°°í¬ì: ${{ github.actor }}

            ìë™ ë¡¤ë°±ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
            ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # 5ë‹¨ê³„: ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
  post-deployment-monitoring:
    name: ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-to-production]
    if: success()
    steps:
      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ì§€ì†ì  í—¬ìŠ¤ì²´í¬ ì‹œì‘
        run: |
          echo "ğŸ” ì§€ì†ì  í—¬ìŠ¤ì²´í¬ ì‹œì‘ (10ë¶„ê°„)"

          # Lambda í•¨ìˆ˜ë¥¼ í†µí•œ ì§€ì†ì  ëª¨ë‹ˆí„°ë§ íŠ¸ë¦¬ê±°
          aws lambda invoke \
            --region ${{ env.AWS_REGION }} \
            --function-name "HanbitTodoStack-prod-DeploymentMonitoring-HealthCheckFunction" \
            --payload '{"deploymentId": "${{ needs.pre-deployment-checks.outputs.deployment-id }}", "monitoringDuration": 600}' \
            monitoring-response.json

          echo "ëª¨ë‹ˆí„°ë§ ì‘ë‹µ:"
          cat monitoring-response.json

      - name: ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "âœ… ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"
          echo "ë°°í¬ ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
          echo "CloudWatch ëŒ€ì‹œë³´ë“œì—ì„œ ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ì„ í™•ì¸í•˜ì„¸ìš”."
