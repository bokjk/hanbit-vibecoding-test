name: í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      skip_tests:
        description: "í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°"
        required: false
        type: boolean
        default: false
      force_deploy:
        description: "ê°•ì œ ë°°í¬ (ê²€ì¦ ê±´ë„ˆë›°ê¸°)"
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8"

jobs:
  # ===========================================
  # ë³€ê²½ì‚¬í•­ ê°ì§€
  # ===========================================
  detect-changes:
    name: ë³€ê²½ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      has-client-changes: ${{ steps.changes.outputs.client }}
      has-server-changes: ${{ steps.changes.outputs.server }}
      has-docs-changes: ${{ steps.changes.outputs.docs }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            client:
              - 'apps/client/**'
              - 'packages/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            server:
              - 'apps/server/**'
              - 'packages/types/**'
            docs:
              - 'docs/**'
              - 'README.md'

  # ===========================================
  # í”„ë¡œë•ì…˜ ë°°í¬ ì „ ê²€ì¦
  # ===========================================
  validation:
    name: ë°°í¬ ì „ ê²€ì¦
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.has-client-changes == 'true' || github.event.inputs.force_deploy == 'true' }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í”„ë¡œë•ì…˜ ê²€ì¦ ì‹¤í–‰
        run: node scripts/production-validation.js
        continue-on-error: ${{ github.event.inputs.force_deploy == 'true' }}

      - name: ê²€ì¦ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: validation-results
          path: |
            validation-report.json
            logs/

  # ===========================================
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # ===========================================
  build-and-test:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [detect-changes, validation]
    if: ${{ needs.detect-changes.outputs.has-client-changes == 'true' || github.event.inputs.force_deploy == 'true' }}

    strategy:
      matrix:
        environment: [staging, production]

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ìºì‹œ
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: TypeScript íƒ€ì… ì²´í¬
        run: pnpm type-check

      - name: ESLint ê²€ì‚¬
        run: pnpm lint

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: pnpm test --run --coverage

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: ${{ always() && github.event.inputs.skip_tests != 'true' }}
        with:
          name: test-results-${{ matrix.environment }}
          path: |
            coverage/
            test-results.xml

      - name: í™˜ê²½ë³„ ë¹Œë“œ
        env:
          NODE_ENV: ${{ matrix.environment }}
        run: |
          cp .env.${{ matrix.environment }} .env.local
          pnpm build

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ê²€ì¦
        run: |
          ls -la apps/client/dist/
          du -sh apps/client/dist/

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.environment }}
          path: apps/client/dist/
          retention-days: 7

  # ===========================================
  # ë³´ì•ˆ ìŠ¤ìº”
  # ===========================================
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.has-client-changes == 'true' || needs.detect-changes.outputs.has-server-changes == 'true' }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
        run: |
          npm audit --audit-level moderate
          pnpm audit --audit-level moderate || true

      - name: SAST ìŠ¤ìº” (CodeQL)
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: CodeQL ë¶„ì„
        uses: github/codeql-action/analyze@v2

      - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-scan-results
          path: |
            security-report.json
            codeql-results/

  # ===========================================
  # ìŠ¤í…Œì´ì§• ë°°í¬
  # ===========================================
  deploy-staging:
    name: ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.environment == 'staging') && always() && needs.build-and-test.result == 'success' }}
    environment:
      name: staging
      url: https://staging.todo-app.com

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: build-staging
          path: dist/

      - name: ìŠ¤í…Œì´ì§• S3ì— ë°°í¬
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_STAGING }}/ --delete \
            --cache-control "public,max-age=31536000" --exclude "*.html" --exclude "service-worker.js"

          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_STAGING }}/ \
            --exclude "*" --include "*.html" --include "service-worker.js" \
            --cache-control "public,max-age=0,must-revalidate"

      - name: CloudFront ìºì‹œ ë¬´íš¨í™” (ìŠ¤í…Œì´ì§•)
        if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_STAGING }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_STAGING }} \
            --paths "/*"

      - name: ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬
        run: |
          for i in {1..5}; do
            if curl -f -s https://staging.todo-app.com/health > /dev/null; then
              echo "âœ… ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬ í†µê³¼"
              exit 0
            fi
            echo "â³ í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ($i/5)..."
            sleep 30
          done
          echo "âŒ ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1

      - name: Slack ì•Œë¦¼ (ìŠ¤í…Œì´ì§•)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#deployments"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,took
          custom_payload: |
            {
              "text": "ìŠ¤í…Œì´ì§• ë°°í¬ ${{ job.status }}",
              "attachments": [{
                "color": "${{ job.status }}" === "success" ? "good" : "danger",
                "fields": [
                  {
                    "title": "í™˜ê²½",
                    "value": "Staging",
                    "short": true
                  },
                  {
                    "title": "ì»¤ë°‹",
                    "value": "${{ github.sha }}",
                    "short": true
                  }
                ]
              }]
            }

  # ===========================================
  # E2E í…ŒìŠ¤íŠ¸ (ìŠ¤í…Œì´ì§• í™˜ê²½)
  # ===========================================
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: ${{ needs.deploy-staging.result == 'success' }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Playwright ì„¤ì¹˜
        run: |
          pnpm install
          pnpm dlx playwright install --with-deps

      - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          pnpm test:e2e --baseURL=https://staging.todo-app.com
        env:
          PLAYWRIGHT_BASE_URL: https://staging.todo-app.com

      - name: E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/

  # ===========================================
  # í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸
  # ===========================================
  production-approval:
    name: í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸
    runs-on: ubuntu-latest
    needs: [deploy-staging, e2e-tests]
    if: ${{ (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production') && always() && needs.deploy-staging.result == 'success' && needs.e2e-tests.result == 'success' }}
    environment:
      name: production-approval

    steps:
      - name: ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸°
        run: echo "í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘..."

  # ===========================================
  # í”„ë¡œë•ì…˜ ë°°í¬
  # ===========================================
  deploy-production:
    name: í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [production-approval, build-and-test]
    if: ${{ always() && needs.production-approval.result == 'success' && needs.build-and-test.result == 'success' }}
    environment:
      name: production
      url: https://todo-app.com

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: build-production
          path: dist/

      - name: í˜„ì¬ í”„ë¡œë•ì…˜ ë°±ì—…
        run: |
          BACKUP_KEY="backups/production/$(date -u +%Y-%m-%dT%H-%M-%S)/"
          aws s3 sync s3://${{ secrets.S3_BUCKET_PRODUCTION }}/ s3://${{ secrets.S3_BUCKET_PRODUCTION }}-backups/${BACKUP_KEY} --delete
          echo "BACKUP_KEY=${BACKUP_KEY}" >> $GITHUB_ENV

      - name: í”„ë¡œë•ì…˜ S3ì— ë°°í¬
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_PRODUCTION }}/ --delete \
            --cache-control "public,max-age=31536000" --exclude "*.html" --exclude "service-worker.js"

          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_PRODUCTION }}/ \
            --exclude "*" --include "*.html" --include "service-worker.js" \
            --cache-control "public,max-age=0,must-revalidate"

      - name: CloudFront ìºì‹œ ë¬´íš¨í™” (í”„ë¡œë•ì…˜)
        if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_PRODUCTION }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_PRODUCTION }} \
            --paths "/*"

      - name: í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬
        id: healthcheck
        run: |
          for i in {1..10}; do
            if curl -f -s https://todo-app.com/health > /dev/null; then
              echo "âœ… í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬ í†µê³¼"
              echo "health_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ($i/10)..."
            sleep 30
          done
          echo "âŒ í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          echo "health_status=failure" >> $GITHUB_OUTPUT
          exit 1

      - name: ë¡¤ë°± (í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ)
        if: ${{ steps.healthcheck.outputs.health_status == 'failure' }}
        run: |
          echo "ğŸ”„ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ë¡œ ë¡¤ë°± ì‹œì‘"
          aws s3 sync s3://${{ secrets.S3_BUCKET_PRODUCTION }}-backups/${{ env.BACKUP_KEY }} s3://${{ secrets.S3_BUCKET_PRODUCTION }}/ --delete

          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_PRODUCTION }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_PRODUCTION }} \
              --paths "/*"
          fi

          echo "âŒ ë°°í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì™„ë£Œ"

      - name: ë°°í¬ ì„±ê³µ íƒœê·¸ ìƒì„±
        if: ${{ steps.healthcheck.outputs.health_status == 'success' && !startsWith(github.ref, 'refs/tags/') }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          VERSION=$(date -u +%Y.%m.%d.%H%M%S)
          git tag -a "v${VERSION}" -m "í”„ë¡œë•ì…˜ ë°°í¬ v${VERSION}"
          git push origin "v${VERSION}"

  # ===========================================
  # ë°°í¬ í›„ ê²€ì¦
  # ===========================================
  post-deployment-verification:
    name: ë°°í¬ í›„ ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy-production
    if: ${{ always() && needs.deploy-production.result == 'success' }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì¢…í•© í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ” ì¢…í•© í—¬ìŠ¤ì²´í¬ ì‹œì‘"

          # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
          curl -f https://todo-app.com/health

          # ì£¼ìš” í˜ì´ì§€ í™•ì¸
          curl -f -s https://todo-app.com/ > /dev/null

          # API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ (ê°€ëŠ¥í•œ ê²½ìš°)
          if [ -n "${{ secrets.API_HEALTH_ENDPOINT }}" ]; then
            curl -f ${{ secrets.API_HEALTH_ENDPOINT }}
          fi

          echo "âœ… ì¢…í•© í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"

      - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘"

          # Lighthouse CI ì„¤ì¹˜ ë° ì‹¤í–‰ (ì„ íƒì )
          if command -v lhci &> /dev/null; then
            lhci autorun --collect.url=https://todo-app.com
          else
            echo "Lighthouse CIê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ - ê±´ë„ˆëœ€"
          fi

      - name: ëª¨ë‹ˆí„°ë§ í™•ì¸
        run: |
          echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸"
          # ì‹¤ì œ ëª¨ë‹ˆí„°ë§ API í˜¸ì¶œ ë“±
          echo "ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì •ìƒ"

  # ===========================================
  # ì•Œë¦¼ ë° ì •ë¦¬
  # ===========================================
  notification:
    name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deployment-verification]
    if: always()

    steps:
      - name: ë°°í¬ ìƒíƒœ ê²°ì •
        id: deploy-status
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" && "${{ needs.post-deployment-verification.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. âŒ" >> $GITHUB_OUTPUT
          fi

      - name: Slack ìµœì¢… ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          channel: "#deployments"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          custom_payload: |
            {
              "text": "${{ steps.deploy-status.outputs.message }}",
              "attachments": [{
                "color": "${{ steps.deploy-status.outputs.status }}" === "success" ? "good" : "danger",
                "fields": [
                  {
                    "title": "í™˜ê²½",
                    "value": "Production",
                    "short": true
                  },
                  {
                    "title": "ë²„ì „",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "URL",
                    "value": "https://todo-app.com",
                    "short": true
                  },
                  {
                    "title": "ë°°í¬ ì‹œê°„",
                    "value": "$(date -u)",
                    "short": true
                  }
                ]
              }]
            }

      - name: ì´ë©”ì¼ ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
        if: ${{ steps.deploy-status.outputs.status == 'failure' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[ê¸´ê¸‰] TODO ì•± í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨"
          to: ${{ secrets.ALERT_EMAIL }}
          from: "GitHub Actions <noreply@todo-app.com>"
          body: |
            í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

            ìì„¸í•œ ë‚´ìš©ì€ GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ===========================================
  # ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
  # ===========================================
  cleanup:
    name: ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
    runs-on: ubuntu-latest
    needs: [notification]
    if: always()

    steps:
      - name: ì˜¤ë˜ëœ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
        run: |
          echo "ğŸ§¹ ì˜¤ë˜ëœ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬"
          # 30ì¼ ì´ìƒ ëœ ì•„í‹°íŒ©íŠ¸ëŠ” ìë™ìœ¼ë¡œ ì‚­ì œë¨
          # ì¶”ê°€ì ì¸ ì •ë¦¬ ë¡œì§ì´ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— êµ¬í˜„

      - name: ì •ë¦¬ ì™„ë£Œ
        run: echo "âœ… ì •ë¦¬ ì‘ì—… ì™„ë£Œ"
